<% 
replies = replies.ascend_by_name
if !params[:show_cancelled]
  replies = replies.not_cancelled
end
total_number_of_guests = replies.not_cancelled.count
replies = replies.all(:include => [:food_preferences, :ticket_type])
%>
<p>
  <% if params[:show_cancelled] %>
    <%= link_to "Show only active", url_for %>
  <% else %>
    <%= link_to "Show cancelled", url_for(:show_cancelled => true) %>
  <% end -%>
</p>


<table class="vertical_header">
  <tr>
    <th>Total number of guests</th>
    <td><%= total_number_of_guests %></td>
  </tr>
</table>

<table border="0" id="guest_list_table">
  <tr>
    <th>Name</th>
    <th>E-mail</th>
    <th>Ticket type</th>
    <th>Payment state</th>
    <th>Guest state</th>
    <th>Food preferences</th>
    <th>Other food related</th>
    <th>Comments</th>
    <th>&nbsp;</th>
  </tr>
  <% replies.each do |reply| %>
    <tr class="<%= cycle('even', 'odd') %>">
      <td><%= reply.name %></td>
      <td><%= reply.email %></td>
      <td><%= reply.ticket_type.name %></td>
      <td><%= payment_state(reply) %></td>
      <td><%= guest_state(reply) %></td>
      <td><%= food_preferences(reply)%></td>
      <td><%= reply.food %></td>
      <td><%= reply.comments %></td>
      <td>
        <% unless reply.attending? %>
          <%= link_to "Attending", set_attending_event_event_replies_path(@event, :name => reply.name), :method => :post %>
        <% end -%>
        <% unless reply.cancelled? %>
          <%= link_to "Remove", event_reply_path(reply), :method => :delete, :confirm => "Do you really want to remove #{reply.name} from the guest list?" %>
        <% end %>
      </td>
    </tr>
    
  <% end -%>
</table>

<table class="vertical_header" id="food_preferences_summary">
  <tr>
    <th>Number of...</th>
    <td>&nbsp;</td>
  </tr>
  
  <% FoodPreference.all.each do |food_preference| %>
  
    <tr>
      <th><%= food_preference.name %></th>
      <td><%= replies.to_a.select { |r| r.food_preferences.include?(food_preference) }.size %></td>
    </tr>
  
  <% end -%>
</table>
